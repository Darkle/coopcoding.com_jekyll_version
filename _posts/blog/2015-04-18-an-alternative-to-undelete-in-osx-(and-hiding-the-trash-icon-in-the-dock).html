<hr />

<p>date: 2015-04-18 15:43:40
tags: [osx,dock,hazel,launchd]</p>

<h2>title: An alternative to undelete in osx (and hiding the trash icon in the dock)</h2>

<h3>Hazel Trash Preference</h3>

<p>I’ve been thinking about getting an undelete program for OSX for a while, but I hadn’t really found one that I liked. A few weeks ago I purchased <a href="http://www.noodlesoft.com/hazel.php">Hazel</a> (for an unrelated thing), and found that it had a really neat feature where it can delete files in your Trash folder if the file os older than X number of days:</p>

<p><img src="http://coopcoding.com/assets/images/blogpostimages/HazelSystemPreferences.png" alt="Hazel System Preferences" /></p>

<p>I realised this could be used as a poor-mans alternative to undelete</p>

<h3>Removing the trash icon from the dock</h3>

<p>One thing that could mess up this system though is accidentally emptying the trash. I have it pretty set in my brain that whenever I see the full trash icon in the dock I should right-click it and empty it, so I figured I’d better remove the trash icon in order to remove the temptation.</p>

<p>After google-ing for a bit, I found <a href="http://apple.stackexchange.com/questions/30415/how-can-i-remove-the-finder-icon-from-my-dock">this post</a> about removing the Finder icon from the dock, and then <a href="https://discussions.apple.com/thread/6638249">this post</a> specifically about removing the Trash icon. Basically you need to alter the <code>/System/Library/CoreServices/Dock.app/Contents/Resources/DockMenus.plist</code> file by inserting some XML to add a “Remove From Dock” option to the right-click menu for the Dock.</p>

<p>In <a href="http://apple.stackexchange.com/questions/30415/how-can-i-remove-the-finder-icon-from-my-dock#comment34912_30429">the comments</a> on the first post, it’s mentioned that you could automate this from the command line by using <code>defaults write</code>, but in practice I found that this converts <code>DocMenus.plist</code> from an XML text file to an XML binary file. The new binary XML file didn’t seem to work for me; no menu showed up on right click even after restarting the dock by running <code>killall Dock</code> from the Terminal, so I had a quick hunt around for XML parsers/editors that work from the command line on OSX.</p>

<p><a href="http://xmlstar.sourceforge.net/">XMLStarlet</a> seemed to be fairly popular so I installed it using the always helpful <a href="http://brew.sh/">Homebrew</a>. (after Homebrew is installed, you just need to run <code>brew install xmlstarlet</code>).</p>

<p>The <code>DockMenus.plist</code> XML looks like this: <a href="https://gist.github.com/Darkle/2ca4152ec3cbc90b8aa9">https://gist.github.com/Darkle/2ca4152ec3cbc90b8aa9</a></p>

<p>Specifically, we are after the array after the <code>&lt;key&gt;trash&lt;/key&gt;</code>:</p>

<p><code>markup
&lt;key&gt;trash&lt;/key&gt;
&lt;array&gt;
  &lt;dict&gt;
    &lt;key&gt;command&lt;/key&gt;
    &lt;integer&gt;1000&lt;/integer&gt;
    &lt;key&gt;name&lt;/key&gt;
    &lt;string&gt;OPEN&lt;/string&gt;
  &lt;/dict&gt;
  &lt;dict&gt;
    &lt;key&gt;command&lt;/key&gt;
    &lt;integer&gt;2000&lt;/integer&gt;
    &lt;key&gt;separator&lt;/key&gt;
    &lt;true/&gt;
  &lt;/dict&gt;
  &lt;dict&gt;
    &lt;key&gt;command&lt;/key&gt;
    &lt;integer&gt;1001&lt;/integer&gt;
    &lt;key&gt;dynamic&lt;/key&gt;
    &lt;integer&gt;0&lt;/integer&gt;
    &lt;key&gt;name&lt;/key&gt;
    &lt;string&gt;EMPTY_TRASH&lt;/string&gt;
  &lt;/dict&gt;
  &lt;dict&gt;
    &lt;key&gt;command&lt;/key&gt;
    &lt;integer&gt;1040&lt;/integer&gt;
    &lt;key&gt;dynamic&lt;/key&gt;
    &lt;integer&gt;2&lt;/integer&gt;
    &lt;key&gt;name&lt;/key&gt;
    &lt;string&gt;SECURE_EMPTY_TRASH&lt;/string&gt;
  &lt;/dict&gt;
&lt;/array&gt;
</code></p>

<p>What we want to do is insert the following XML into the array element immediately after the <code>&lt;key&gt;trash&lt;/key&gt;</code> element:</p>

<p><code>markup
&lt;dict&gt;
  &lt;key&gt;command&lt;/key&gt;
  &lt;integer&gt;1004&lt;/integer&gt;
  &lt;key&gt;name&lt;/key&gt;
  &lt;string&gt;REMOVE_FROM_DOCK&lt;/string&gt;
&lt;/dict&gt;
</code></p>

<p>After reading through the <a href="http://xmlstar.sourceforge.net/doc/UG/xmlstarlet-ug.html#idm47077139594320">documentation for editing XML files</a> in XMLStarlet, it seemed like the natural thing to use would be the <code>-a</code> option to append new XML elements like so:</p>

<p><code>bash
xml ed -a "/foo/bar" -t elem -n dict
</code></p>

<p>(<code>ed</code> command is for editing, <code>-a</code> option is for “append”, <code>-t</code> is for the type of element you are appending, in this case an “elem” or element and <code>-n</code> for the name of the element).</p>

<p>but for some reason append in XMLStarlet inserts the new element you are creating as a sibling to the element you selected in the xpath. So you seem to need to use the <code>-s</code> subnode command to insert elements as childnodes of the element the xpath selects.</p>

<p>To get the trash key via xpath, we can use</p>

<p><code>bash
"/plist/dict/key[.='trash']" ...
</code></p>

<p>then we grab the first sibling and make sure it’s an array</p>

<p><code>bash
"/following-sibling::*[1][self::array]"
</code></p>

<p>so all up its</p>

<p><code>bash
"/plist/dict/key[.='trash']/following-sibling::*[1][self::array]"
</code></p>

<p>Then as the XMLStarlet command</p>

<p><code>bash
xml ed -L -s "/plist/dict/key[.='trash']/following-sibling::*[1][self::array]" -t elem -n dict
</code></p>

<p>(<code>-L</code> option means to <a href="http://stackoverflow.com/questions/5954168/how-to-insert-a-new-element-under-another-with-xmlstarlet/9172796#9172796">edit the file in place</a>)</p>

<p>This should result in the following XML inside the trash array</p>

<p><code>markup
&lt;array&gt;
  &lt;dict&gt;
    &lt;key&gt;command&lt;/key&gt;
    &lt;integer&gt;1000&lt;/integer&gt;
    &lt;key&gt;name&lt;/key&gt;
    &lt;string&gt;OPEN&lt;/string&gt;
  &lt;/dict&gt;
  &lt;dict&gt;
    &lt;key&gt;command&lt;/key&gt;
    &lt;integer&gt;2000&lt;/integer&gt;
    &lt;key&gt;separator&lt;/key&gt;
    &lt;true/&gt;
  &lt;/dict&gt;
  &lt;dict&gt;
    &lt;key&gt;command&lt;/key&gt;
    &lt;integer&gt;1001&lt;/integer&gt;
    &lt;key&gt;dynamic&lt;/key&gt;
    &lt;integer&gt;0&lt;/integer&gt;
    &lt;key&gt;name&lt;/key&gt;
    &lt;string&gt;EMPTY_TRASH&lt;/string&gt;
  &lt;/dict&gt;
  &lt;dict&gt;
    &lt;key&gt;command&lt;/key&gt;
    &lt;integer&gt;1040&lt;/integer&gt;
    &lt;key&gt;dynamic&lt;/key&gt;
    &lt;integer&gt;2&lt;/integer&gt;
    &lt;key&gt;name&lt;/key&gt;
    &lt;string&gt;SECURE_EMPTY_TRASH&lt;/string&gt;
  &lt;/dict&gt;
  &lt;dict&gt;
  &lt;/dict&gt;
&lt;/array&gt;
</code></p>

<p>The lack of attributes (classes or id’s) or text in the dict elements makes it tough to be sure we are getting the right one to next insert the</p>

<p><code>markup
&lt;key&gt;command&lt;/key&gt;
&lt;integer&gt;1004&lt;/integer&gt;
&lt;key&gt;name&lt;/key&gt;
&lt;string&gt;REMOVE_FROM_DOCK&lt;/string&gt;
</code></p>

<p>so I used the xpath option of checking for a dict element that had no child nodes, and then giving it a unique id to make the rest of the XML editing easier</p>

<p><code>bash
xml ed -L -s "/plist/dict/key[.='trash']/following-sibling::*[1][self::array]" -t elem -n dict \
-i "/plist/dict/key[.='trash']/following-sibling::*[1][self::array]/dict[not(*)]" -t "attr" -n "id" -v "removeFromDockDictionaryInsert"
</code></p>

<p>With XMLStarlet you can chain commands, so this is just the first subnode command with the new commands added at the end. You see we’re using the <code>-i</code> option to insert something and that something’s type is an attribute (“attr”) with a name of “id” and a value of ”removeFromDockDictionaryInsert”.</p>

<p>Now it’s easier to add more elements by just querying</p>

<p><code>bash
"//dict[@id='removeFromDockDictionaryInsert']"
</code></p>

<p>Here is the final complete command</p>

<p><code>bash
xml ed -L -s "/plist/dict/key[.='trash']/following-sibling::*[1][self::array]" -t elem -n dict \
-i "/plist/dict/key[.='trash']/following-sibling::*[1][self::array]/dict[not(*)]" -t "attr" -n "id" -v "removeFromDockDictionaryInsert" \
-s "//dict[@id='removeFromDockDictionaryInsert']" -t elem -n key -v "command" \
-s "//dict[@id='removeFromDockDictionaryInsert']" -t elem -n integer -v 1004 \
-s "//dict[@id='removeFromDockDictionaryInsert']" -t elem -n key -v "name" \
-s "//dict[@id='removeFromDockDictionaryInsert']" -t elem -n string -v "REMOVE_FROM_DOCK" DocMenus.plist
</code></p>

<p>After this is run on the <code>DocMenus.plist</code> file, your right-click menu for the Trash icon in the dock should look like this:</p>

<p><img src="http://coopcoding.com/assets/images/blogpostimages/RemoveFromDockMenu.jpg" alt="Remove From Dock Menu" /></p>

<h3>Removing on startup via launchd</h3>

<p>I decided on using a bash script to backup the default <code>DockMenus.plist</code>file, run the XMLStarlet commands and then hide the Trash icon via an applescript.</p>

<p>The bash script looks as follows</p>

<p>``` bash</p>

<h1>!/bin/sh</h1>

<p>export PATH=/usr/local/bin:$PATH</p>

<h3>Back up the DockMenus.plist file</h3>

<p>origPlist=/System/Library/CoreServices/Dock.app/Contents/Resources/DockMenus;
backupFolder=/Users/coop/Dropbox/OSXStuff/DockTrashScripts
cp $origPlist.plist $backupFolder/DockMenus-BAK.plist;</p>

<h3>Edit the DockMenus.plist file with XMLStarlet</h3>

<p>xml ed -L -s &ldquo;/plist/dict/key[.=&lsquo;trash&rsquo;]/following-sibling::<em>[1][self::array]&rdquo; -t elem -n dict -i &ldquo;/plist/dict/key[.=&lsquo;trash&rsquo;]/following-sibling::</em>[1][self::array]/dict[not(*)]&rdquo; -t &ldquo;attr&rdquo; -n &ldquo;id&rdquo; -v &ldquo;removeFromDockDictionaryInsert&rdquo; -s &ldquo;//dict[@id=&lsquo;removeFromDockDictionaryInsert&rsquo;]&rdquo; -t elem -n key -v &ldquo;command&rdquo; -s &ldquo;//dict[@id=&lsquo;removeFromDockDictionaryInsert&rsquo;]&rdquo; -t elem -n integer -v 1004 -s &ldquo;//dict[@id=&lsquo;removeFromDockDictionaryInsert&rsquo;]&rdquo; -t elem -n key -v &ldquo;name&rdquo; -s &ldquo;//dict[@id=&lsquo;removeFromDockDictionaryInsert&rsquo;]&rdquo; -t elem -n string -v &ldquo;REMOVE_FROM_DOCK&rdquo; $origPlist.plist</p>

<h3>Run the applescript that select the right-click menu to hide the Trash icon</h3>

<p>osascript $backupFolder/HideTrashIconInDock.scpt
```</p>

<p>and then make it executable by running <code>chmod +x</code> on the bash script file.</p>

<p>In the <code>HideTrashIconInDock.scpt</code> script is the following Applescript</p>

<p><code>applescript
tell application "System Events" to tell process "Dock"
    tell UI element "Trash" of list 1
        perform action "AXShowMenu"
        click menu item "Remove from Dock" of menu 1
    end tell
end tell
</code></p>

<p>What this does is it uses the accessibility features in OSX to show the right-click menu for the trash then select the &ldquo;Remove from Dock” option.</p>

<p>Then I created a file called <code>com.coop.removeTrashIconFromDock.plist</code> in the <code>/Users/coop/Library/LaunchAgents/</code>folder conatining the following XML</p>

<p><code>markup
&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"&gt;
&lt;plist version="1.0"&gt;
    &lt;dict&gt;
        &lt;key&gt;Label&lt;/key&gt;
        &lt;string&gt;com.coop.removeTrashIconFromDock&lt;/string&gt;
        &lt;key&gt;Program&lt;/key&gt;
        &lt;string&gt;/Users/coop/Dropbox/OSXStuff/DockTrashScripts/bakupAndAlterPlist.sh&lt;/string&gt;
        &lt;key&gt;RunAtLoad&lt;/key&gt;
        &lt;true/&gt;
    &lt;/dict&gt;
&lt;/plist&gt;
</code></p>

<p>This file will be run by <a href="http://launchd.info/">launchd</a> on startup. When this runs the first time, you will probably be asked to give <code>bakupAndAlterPlist.sh</code> Accessibility access in the OSX preferences.</p>

<p>If you don’t want to wait for a restart to load the Launch Agent, you can use the following command:</p>

<p><code>bash
launchctl load ~/Library/LaunchAgents/com.coop.removeTrashIconFromDock.plist
</code></p>

<p>and to unload</p>

<p><code>bash
launchctl unload  ~/Library/LaunchAgents/com.coop.removeTrashIconFromDock.plist
</code></p>

<p>More info here: <a href="http://launchd.info/">http://launchd.info/)</a> (click on the “Operation” tab</p>

<p>Side note: For messing around with applescript in the terminal or in the applescript script editor with scripts that need to accesses accessibility features, you might want to add Terminal.app, <a href="http://jacobsalmela.com/os-x-yosemite-osascript-enabling-access-assistive-devices/">osascript</a> and Script Editor.app to the Security and Privacy Accessibility</p>

<p><img src="https://support.apple.com/library/content/dam/edam/applecare/images/en_US/osx/privacy_prefs.png" alt="Security &amp; Privacy Preferences" /></p>
